(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[833],{3779:(t,e,i)=>{Promise.resolve().then(i.bind(i,9121))},6311:(t,e,i)=>{"use strict";i.d(e,{N:()=>r});var s=i(7013);class r{async loadSprites(){for(let t of r.SPRITE_FILES)try{let e=new Image;e.src=(0,s.O)(t),await new Promise((i,s)=>{e.onload=()=>i(),e.onerror=()=>{let e=Error("Failed to load sprite: ".concat(t));console.error(e.message),s(e)}}),this.spriteImages.set(t,e),this.processSprite(t,e)}catch(e){console.error("Failed to load sprite: ".concat(t),e)}console.log("Loaded sprites:",Array.from(this.sprites.keys()))}processSprite(t,e){let i=Math.floor(e.width/r.TILE_SIZE),s=Math.floor(e.height/r.TILE_SIZE);for(let a=0;a<s;a++)for(let s=0;s<i;s++){let i="".concat(t,"#").concat(s,",").concat(a),n={image:e,x:s*r.TILE_SIZE,y:a*r.TILE_SIZE,width:r.TILE_SIZE,height:r.TILE_SIZE};this.sprites.set(i,{id:i,path:t,frames:[n],category:this.getCategoryFromPath(t),tags:this.getTagsFromPath(t)})}}getCategoryFromPath(t){var e;let i=t.split("/");if(i.length<3)return"Unknown";let s=null!=(e=i[1])?e:"";return s.charAt(0).toUpperCase()+s.slice(1)}getTagsFromPath(t){let e=t.split("/"),i=[];if(e[1]&&i.push(e[1].toLowerCase()),e[2]){var s;let t=null!=(s=e[2].split(".")[0])?s:"";t&&i.push(t.toLowerCase())}return i}getSprite(t){return this.sprites.get(t)}getAllSprites(){return Array.from(this.sprites.values())}getSpritesByCategory(t){return this.getAllSprites().filter(e=>e.category===t)}getSpritesByTag(t){return this.getAllSprites().filter(e=>{var i;return null==(i=e.tags)?void 0:i.includes(t)})}renderSprite(t,e,i,s){let r=this.getSprite(e);if(!(null==r?void 0:r.frames[0]))return;let a=r.frames[0];t.drawImage(a.image,a.x,a.y,a.width,a.height,i,s,a.width,a.height)}constructor(){this.sprites=new Map,this.spriteImages=new Map,this.loadSprites()}}r.TILE_SIZE=16,r.SPRITE_FILES=["/sprites/Characters/champions/Okomo.png","/sprites/Objects/SwordShort.png","/sprites/Objects/Spear.png","/sprites/Objects/ShortBig.png","/sprites/Objects/FireballProjectile.png","/sprites/Objects/Bullet.png","/sprites/Objects/BallistaBolt.png","/sprites/Objects/Axe.png","/sprites/Objects/ArrowShort.png","/sprites/Objects/ArrowLong.png","/sprites/Animals/Sheep.png","/sprites/Animals/Pig.png","/sprites/Animals/MarineAnimals.png","/sprites/Animals/Horse(32x32).png","/sprites/Animals/HornedSheep.png","/sprites/Animals/Chicken.png","/sprites/Animals/Chick.png","/sprites/Animals/Boar.png","/sprites/Buildings/wood/Barracks.png","/sprites/Buildings/wood/CaveV2.png","/sprites/Buildings/wood/Docks.png","/sprites/Buildings/wood/Houses.png","/sprites/Ground/TexturedGrass.png","/sprites/Ground/Shore.png","/sprites/Ground/Grass.png","/sprites/Ground/Cliff.png","/sprites/Ground/Winter.png","/sprites/Miscellaneous/Boat.png","/sprites/Miscellaneous/Chests.png","/sprites/Miscellaneous/Tombstones.png","/sprites/Miscellaneous/StreetSigns.png","/sprites/Miscellaneous/Signs.png","/sprites/Miscellaneous/QuestBoard.png","/sprites/Miscellaneous/Portal.png","/sprites/Miscellaneous/PirateShip.png","/sprites/Miscellaneous/Bridge.png","/sprites/Nature/Cactus.png","/sprites/Nature/Rocks.png","/sprites/Nature/Wheatfield.png","/sprites/Nature/WinterTrees.png","/sprites/Nature/Tumbleweed.png","/sprites/Nature/Trees.png","/sprites/Nature/PineTrees.png"]},7013:(t,e,i)=>{"use strict";function s(t){let e=t.startsWith("/")?t.slice(1):t;return"".concat("/world-sim","/").concat(e)}i.d(e,{O:()=>s})},9121:(t,e,i)=>{"use strict";i.r(e),i.d(e,{default:()=>N});var s=i(6384),r=i(6636),a=i(4582);class n{start(){this.isRunning||(this.isRunning=!0,this.lastTimestamp=performance.now(),this.accumulator=0,this.gameLoop())}stop(){this.isRunning=!1,null!==this.animationFrameId&&(cancelAnimationFrame(this.animationFrameId),this.animationFrameId=null)}gameLoop(){if(!this.isRunning)return;let t=performance.now(),e=t-this.lastTimestamp;for(this.lastTimestamp=t,this.accumulator+=e,this.frameCount++,this.fpsTimer+=e,this.fpsTimer>=1e3&&(this.currentFPS=this.frameCount,this.frameCount=0,this.fpsTimer=0);this.accumulator>=this.FRAME_DURATION;){let e=t-this.lastUpdateTime>=this.UPDATE_INTERVAL;this.updateCallback(this.FRAME_DURATION/1e3,e),this.accumulator-=this.FRAME_DURATION,e&&(this.lastUpdateTime=t)}this.renderCallback(),this.animationFrameId=requestAnimationFrame(()=>this.gameLoop())}getCurrentFPS(){return this.currentFPS}getTargetFPS(){return this.TARGET_FPS}getGameTime(){return performance.now()}constructor(t,e){this.isRunning=!1,this.lastTimestamp=0,this.animationFrameId=null,this.TARGET_FPS=60,this.FRAME_DURATION=1e3/this.TARGET_FPS,this.accumulator=0,this.frameCount=0,this.fpsTimer=0,this.currentFPS=0,this.lastUpdateTime=0,this.UPDATE_INTERVAL=16.67,this.updateCallback=t,this.renderCallback=e}}class o{setCanvas(t){this.canvas=t,this.setupMouseListeners(t)}setupEventListeners(){window.addEventListener("keydown",t=>{var e;let i=null!=(e=o.keyMap[t.key])?e:t.key.toLowerCase();!this.keyState[i]&&(this.justPressed[i]=!0,(i in o.keyMap||["attack","interact","inventory"].includes(i)||i.startsWith("slot"))&&console.log("Key pressed: ".concat(t.key," → ").concat(i))),this.keyState[i]=!0,this.keys.add(i)}),window.addEventListener("keyup",t=>{var e;let i=null!=(e=o.keyMap[t.key])?e:t.key.toLowerCase();this.keyState[i]=!1,this.keys.delete(i),this.justPressed[i]=!1})}setupMouseListeners(t){t.addEventListener("mousedown",t=>{this.isDragging=!0,this.dragStart={x:t.clientX,y:t.clientY},this.lastMouse={x:t.clientX,y:t.clientY},this.dragDelta={x:0,y:0}}),t.addEventListener("mousemove",t=>{if(this.isDragging&&this.lastMouse){let e=t.clientX-this.lastMouse.x,i=t.clientY-this.lastMouse.y;this.dragDelta.x+=e,this.dragDelta.y+=i,this.lastMouse={x:t.clientX,y:t.clientY}}}),t.addEventListener("mouseup",t=>{this.dragStart&&5>Math.sqrt(Math.pow(t.clientX-this.dragStart.x,2)+Math.pow(t.clientY-this.dragStart.y,2))&&(this.mouseClick={x:t.clientX,y:t.clientY}),this.isDragging=!1,this.dragStart=null,this.lastMouse=null}),t.addEventListener("mouseleave",t=>{this.isDragging=!1,this.dragStart=null,this.lastMouse=null})}update(){this.justPressed={}}getMouseClick(){let t=this.mouseClick;return this.mouseClick=null,t}isKeyPressed(t){var e;return null!=(e=this.keyState[t])&&e}wasKeyJustPressed(t){var e;return null!=(e=this.justPressed[t])&&e}getMovementDirection(){let t=0,e=0;return this.isKeyPressed("up")&&(e-=1),this.isKeyPressed("down")&&(e+=1),this.isKeyPressed("left")&&(t-=1),this.isKeyPressed("right")&&(t+=1),{x:t,y:e}}constructor(t){this.canvas=t,this.isDragging=!1,this.dragStart=null,this.lastMouse=null,this.dragDelta={x:0,y:0},this.mouseClick=null,this.keys=new Set,this.keyState={},this.justPressed={},this.setupEventListeners(),t&&this.setupMouseListeners(t)}}o.keyMap={w:"up",ArrowUp:"up",s:"down",ArrowDown:"down",a:"left",ArrowLeft:"left",d:"right",ArrowRight:"right",q:"attack",f:"interact",e:"inventory",1:"slot1",2:"slot2",3:"slot3",4:"slot4",5:"slot5",6:"slot6",7:"slot7",8:"slot8",9:"slot9"};var l=i(5955),h=i(1623),c=i.n(h),u=i(7013);class p{async loadImage(){try{this.image=new Image,this.image.src=(0,u.O)(this.config.imagePath),await new Promise((t,e)=>{if(!this.image)return void e(Error("Image is null"));this.image.onload=()=>{this.processFrames(),this.isLoaded=!0,t()},this.image.onerror=()=>{e(Error("Failed to load sprite: ".concat(this.config.imagePath)))}})}catch(t){console.error("Failed to load sprite: ".concat(this.config.imagePath),t)}}processFrames(){if(this.image){this.frames=[];for(let t=0;t<this.totalFrames;t++){let e=Math.floor(t/this.framesPerRow),i=t%this.framesPerRow;this.frames.push({image:this.image,x:i*this.frameWidth,y:e*this.frameHeight,width:this.frameWidth,height:this.frameHeight})}}}update(t){if(!this.isLoaded||this.frames.length<=1)return;this.lastFrameTime+=1e3*t;let e=this.animationDuration/this.totalFrames;this.lastFrameTime>=e&&(this.lastFrameTime=0,this.loop?this.currentFrame=(this.currentFrame+1)%this.totalFrames:this.currentFrame<this.totalFrames-1&&this.currentFrame++)}render(t,e,i){let s=arguments.length>3&&void 0!==arguments[3]?arguments[3]:1;if(!this.isLoaded||!this.frames[this.currentFrame])return;let r=this.frames[this.currentFrame];r&&t.drawImage(r.image,r.x,r.y,r.width,r.height,e,i,r.width*s,r.height*s)}setFrame(t){t>=0&&t<this.totalFrames&&(this.currentFrame=t)}getCurrentFrame(){return this.currentFrame}getFrameCount(){return this.totalFrames}isAnimationComplete(){return!this.loop&&this.currentFrame===this.totalFrames-1}reset(){this.currentFrame=0,this.lastFrameTime=0}isImageLoaded(){return this.isLoaded}canAdvanceFrame(){return!!this.loop||this.currentFrame<this.totalFrames-1}getNextFrame(){return this.loop?(this.currentFrame+1)%this.totalFrames:Math.min(this.currentFrame+1,this.totalFrames-1)}constructor(t){var e,i;this.config=t,this.image=null,this.frames=[],this.currentFrame=0,this.lastFrameTime=0,this.isLoaded=!1,this.animationDuration=null!=(e=t.animationDuration)?e:1e3,this.loop=!1!==t.loop,this.totalFrames=t.totalFrames,this.frameWidth=t.frameWidth,this.frameHeight=t.frameHeight,this.framesPerRow=null!=(i=t.framesPerRow)?i:this.totalFrames,this.loadImage()}}class g{render(t){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:1;this.isDestroyed||this.sprite.render(t,this.x,this.y,e)}renderAtScreenPosition(t,e,i){let s=arguments.length>3&&void 0!==arguments[3]?arguments[3]:1;this.isDestroyed||this.sprite.render(t,e,i,s)}takeDamage(t){return this.isDestroyed?{destroyed:!1,dropValue:0,dropType:""}:(this.health-=t,this.health<=0)?(this.isDestroyed=!0,{destroyed:!0,dropValue:this.dropValue,dropType:this.dropType}):{destroyed:!1,dropValue:0,dropType:""}}getHealth(){return this.health}getMaxHealth(){return this.maxHealth}getHealthPercentage(){return this.health/this.maxHealth}isStructureDestroyed(){return this.isDestroyed}getDropInfo(){return{dropValue:this.dropValue,dropType:this.dropType}}constructor(t){this.isDestroyed=!1,this.x=t.x,this.y=t.y,this.health=t.health,this.maxHealth=t.health,this.dropValue=t.dropValue,this.dropType=t.dropType,this.sprite=this.createSprite()}}var d=function(t){return t[t.CUT_DOWN=0]="CUT_DOWN",t[t.YOUNG=1]="YOUNG",t[t.TALL=2]="TALL",t[t.FULL=3]="FULL",t}({});class m extends g{createSprite(){var t;return new p({imagePath:"/sprites/Nature/Trees.png",frameWidth:16,frameHeight:16,totalFrames:4,framesPerRow:4,animationDuration:4*(null!=(t=this.growthTimePerStage)?t:36e5),loop:!1})}update(t){this.isGrowthComplete||(this.timeSinceLastGrowth+=1e3*t,this.timeSinceLastGrowth>=this.growthTimePerStage&&this.canGrow()&&(this.grow(),this.timeSinceLastGrowth=0),this.sprite.update(t))}render(t){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:1;this.sprite.render(t,this.x,this.y,e)}renderAtScreenPosition(t,e,i){let s=arguments.length>3&&void 0!==arguments[3]?arguments[3]:1;this.sprite.render(t,e,i,s)}grow(){this.currentStage<3&&(this.currentStage++,this.sprite.setFrame(this.currentStage),3===this.currentStage&&(this.isGrowthComplete=!0))}canGrow(){return this.currentStage<3}cutDown(){this.currentStage=0,this.sprite.setFrame(this.currentStage),this.isGrowthComplete=!1,this.timeSinceLastGrowth=0}plant(){0===this.currentStage&&(this.currentStage=1,this.sprite.setFrame(this.currentStage),this.isGrowthComplete=!1,this.timeSinceLastGrowth=0)}getCurrentStage(){return this.currentStage}getGrowthProgress(){return this.isGrowthComplete?1:this.timeSinceLastGrowth/this.growthTimePerStage}isFullyGrown(){return 3===this.currentStage}isCutDown(){return 0===this.currentStage}forceGrowthStage(t){this.currentStage=t,this.sprite.setFrame(t),this.isGrowthComplete=3===t,this.timeSinceLastGrowth=0}takeDamage(t){let e=super.takeDamage(t);return e.destroyed&&this.cutDown(),e}constructor(t){var e,i;super({...t,health:50,dropValue:5,dropType:"wood"}),this.timeSinceLastGrowth=0,this.isGrowthComplete=!1,this.currentStage=null!=(e=t.initialStage)?e:1,this.growthTimePerStage=null!=(i=t.growthTimePerStage)?i:36e5,this.sprite=this.createSprite(),this.sprite.setFrame(this.currentStage)}}var y=function(t){return t[t.VARIANT_1=1]="VARIANT_1",t[t.VARIANT_2=2]="VARIANT_2",t[t.VARIANT_3=3]="VARIANT_3",t}({});class S extends g{createSprite(){var t,e,i;let s=null!=(e=null==(t=this.frameSequence)?void 0:t.length)?e:2;return new p({imagePath:"/sprites/Nature/Cactus.png",frameWidth:16,frameHeight:16,totalFrames:8,framesPerRow:8,animationDuration:(null!=(i=this.growthTimePerStage)?i:6e5)*s,loop:!1})}getRandomVariant(){var t;let e=[1,2,3];return null!=(t=e[Math.floor(Math.random()*e.length)])?t:1}getFrameSequence(t){switch(t){case 1:default:return[4,3];case 2:return[5,6,7];case 3:return[1,0]}}update(t){this.isGrowthComplete||(this.timeSinceLastGrowth+=1e3*t,this.timeSinceLastGrowth>=this.growthTimePerStage&&this.canGrow()&&(this.grow(),this.timeSinceLastGrowth=0),this.sprite.update(t))}render(t){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:1;this.sprite.render(t,this.x,this.y,e)}renderAtScreenPosition(t,e,i){let s=arguments.length>3&&void 0!==arguments[3]?arguments[3]:1;this.sprite.render(t,e,i,s)}grow(){if(this.currentStage<this.frameSequence.length-1){var t;this.currentStage++,this.sprite.setFrame(null!=(t=this.frameSequence[this.currentStage])?t:0),this.currentStage===this.frameSequence.length-1&&(this.isGrowthComplete=!0)}}canGrow(){return this.currentStage<this.frameSequence.length-1}getCurrentStage(){return this.currentStage}getVariant(){return this.variant}getGrowthProgress(){return this.isGrowthComplete?1:this.timeSinceLastGrowth/this.growthTimePerStage}isFullyGrown(){return this.currentStage===this.frameSequence.length-1}forceGrowthStage(t){if(t>=0&&t<this.frameSequence.length){var e;this.currentStage=t,this.sprite.setFrame(null!=(e=this.frameSequence[t])?e:0),this.isGrowthComplete=t===this.frameSequence.length-1,this.timeSinceLastGrowth=0}}constructor(t){var e,i,s,r;super({...t,health:15,dropValue:1,dropType:"cactus"}),this.timeSinceLastGrowth=0,this.isGrowthComplete=!1,this.variant=null!=(e=t.variant)?e:this.getRandomVariant(),this.currentStage=null!=(i=t.initialStage)?i:0,this.growthTimePerStage=null!=(s=t.growthTimePerStage)?s:6e5,this.frameSequence=this.getFrameSequence(this.variant),this.sprite=this.createSprite(),this.sprite.setFrame(null!=(r=this.frameSequence[this.currentStage])?r:0)}}let f={health_potion:{name:"Health Potion",spritePath:"/sprites/User Interface/Icons-Essentials.png",index:4,category:"inventory",properties:{maxStack:16}},poison_potion:{name:"Poison Potion",spritePath:"/sprites/User Interface/Icons-Essentials.png",index:5,category:"inventory",properties:{maxStack:16}},magic_potion:{name:"Magic Potion",spritePath:"/sprites/User Interface/Icons-Essentials.png",index:6,category:"inventory",properties:{maxStack:16}},stamina_potion:{name:"Stamina Potion",spritePath:"/sprites/User Interface/Icons-Essentials.png",index:7,category:"inventory",properties:{maxStack:16}},wheat:{name:"Wheat",spritePath:"/sprites/User Interface/Icons-Essentials.png",index:8,category:"inventory",properties:{maxStack:64}},health_heart:{name:"Health Heart",spritePath:"/sprites/User Interface/Icons-Essentials.png",index:9,category:"inventory",properties:{maxStack:1}},wood:{name:"Wood",spritePath:"/sprites/User Interface/Icons-Essentials.png",index:10,category:"inventory",properties:{maxStack:64}},cactus:{name:"Cactus",spritePath:"/sprites/User Interface/Icons-Essentials.png",index:11,category:"inventory",properties:{maxStack:64}},hammer:{name:"Hammer",spritePath:"/sprites/User Interface/UiIcons.png",index:0,category:"inventory",properties:{maxStack:1,damage:15}},sword:{name:"Sword",spritePath:"/sprites/User Interface/UiIcons.png",index:1,category:"inventory",properties:{maxStack:1,damage:20}},shield:{name:"Shield",spritePath:"/sprites/User Interface/UiIcons.png",index:2,category:"inventory",properties:{maxStack:1}},dagger:{name:"Dagger",spritePath:"/sprites/User Interface/UiIcons.png",index:44,category:"inventory",properties:{maxStack:1,damage:10}},arrow_horizontal:{name:"Arrow (Horizontal)",spritePath:"/sprites/User Interface/UiIcons.png",index:45,category:"projectile",properties:{damage:15}},arrow_vertical:{name:"Arrow (Vertical)",spritePath:"/sprites/User Interface/UiIcons.png",index:3,category:"projectile",properties:{damage:15}},settings_icon:{name:"Settings",spritePath:"/sprites/User Interface/UiIcons.png",index:42,category:"ui"},chat_icon:{name:"Chat",spritePath:"/sprites/User Interface/UiIcons.png",index:41,category:"ui"},notification_icon:{name:"Notification",spritePath:"/sprites/User Interface/UiIcons.png",index:40,category:"ui"},warning_icon:{name:"Warning",spritePath:"/sprites/User Interface/UiIcons.png",index:31,category:"ui"},confirm_icon:{name:"Confirm",spritePath:"/sprites/User Interface/UiIcons.png",index:30,category:"ui"},question_icon:{name:"Question",spritePath:"/sprites/User Interface/UiIcons.png",index:29,category:"ui"},reject_icon:{name:"Reject",spritePath:"/sprites/User Interface/UiIcons.png",index:28,category:"ui"},default_item_box:{name:"Default Item Box",spritePath:"/sprites/User Interface/Highlighted-Boxes.png",index:0,category:"ui"},broken_item_box:{name:"Broken Item Box",spritePath:"/sprites/User Interface/Highlighted-Boxes.png",index:3,category:"ui"},highlighted_item_box:{name:"Highlighted Item Box",spritePath:"/sprites/User Interface/Highlighted-Boxes.png",index:4,category:"ui"},box_selector:{name:"Box Selector",spritePath:"/sprites/User Interface/BoxSelector.png",index:0,category:"ui"},pressed_box_selector:{name:"Pressed Box Selector",spritePath:"/sprites/User Interface/BoxSelector.png",index:1,category:"ui"},rock:{name:"Rock",spritePath:"/sprites/User Interface/Icons-Essentials.png",index:12,category:"inventory",properties:{maxStack:64,interactable:!0,passable:!1}},gold_ore:{name:"Gold Ore",spritePath:"/sprites/User Interface/Icons-Essentials.png",index:13,category:"inventory",properties:{maxStack:64,rarity:"very_rare",dropItems:[{type:"gold_ingot",quantity:1}]}},iron_ore:{name:"Iron Ore",spritePath:"/sprites/User Interface/Icons-Essentials.png",index:14,category:"inventory",properties:{maxStack:64,rarity:"rare",dropItems:[{type:"iron_ingot",quantity:1}]}},copper_ore:{name:"Copper Ore",spritePath:"/sprites/User Interface/Icons-Essentials.png",index:15,category:"inventory",properties:{maxStack:64,rarity:"common",dropItems:[{type:"copper_ingot",quantity:1}]}},gold_ingot:{name:"Gold Ingot",spritePath:"/sprites/User Interface/Icons-Essentials.png",index:0,category:"inventory",properties:{maxStack:64}},iron_ingot:{name:"Iron Ingot",spritePath:"/sprites/User Interface/Icons-Essentials.png",index:1,category:"inventory",properties:{maxStack:64}},copper_ingot:{name:"Copper Ingot",spritePath:"/sprites/User Interface/Icons-Essentials.png",index:2,category:"inventory",properties:{maxStack:64}},fireball_frame_0:{name:"Fireball",spritePath:"/sprites/Objects/FireballProjectile.png",index:0,category:"poi",properties:{damage:25,animated:!0,animationFrames:[0,1]}},magic_fire_frame_0:{name:"Magic Fire",spritePath:"/sprites/Objects/FireballProjectile.png",index:3,category:"poi",properties:{damage:35,animated:!0,animationFrames:[3,2]}},wheat_field_0:{name:"Wheat Field (Young)",spritePath:"/sprites/Nature/Wheatfield.png",index:0,category:"poi",properties:{animated:!0,animationFrames:[0,1,2,3],interactable:!0,dropItems:[{type:"wheat",quantity:3}]}},boat_vertical:{name:"Boat (Vertical)",spritePath:"/sprites/Miscellaneous/Boat.png",index:0,category:"poi",properties:{interactable:!0,passable:!0,tileTypeRequired:["SHALLOW_WATER","DEEP_WATER"]}},boat_horizontal:{name:"Boat (Horizontal)",spritePath:"/sprites/Miscellaneous/Boat.png",index:2,category:"poi",properties:{interactable:!0,passable:!0,tileTypeRequired:["SHALLOW_WATER","DEEP_WATER"]}},normal_chest:{name:"Normal Chest",spritePath:"/sprites/Miscellaneous/Chests.png",index:0,category:"poi",properties:{interactable:!0,passable:!1}},rare_chest:{name:"Rare Chest",spritePath:"/sprites/Miscellaneous/Chests.png",index:1,category:"poi",properties:{interactable:!0,passable:!1,rarity:"rare"}},portal:{name:"Portal",spritePath:"/sprites/Miscellaneous/Portal.png",index:3,category:"poi",properties:{interactable:!0,passable:!0}},empty_notice_board:{name:"Empty Notice Board",spritePath:"/sprites/Miscellaneous/QuestBoard.png",index:0,category:"poi",properties:{interactable:!0,passable:!1}},notice_board:{name:"Notice Board",spritePath:"/sprites/Miscellaneous/QuestBoard.png",index:1,category:"poi",properties:{interactable:!0,passable:!1}},tombstone:{name:"Tombstone",spritePath:"/sprites/Miscellaneous/Tombstones.png",index:6,category:"poi",properties:{interactable:!0,passable:!1}},water_well:{name:"Water Well",spritePath:"/sprites/Miscellaneous/Well.png",index:3,category:"poi",properties:{interactable:!0,passable:!1}},sand_tile:{name:"Sand Tile",spritePath:"/sprites/Ground/Shore.png",index:0,category:"background"},shallow_water_tile:{name:"Shallow Water Tile",spritePath:"/sprites/Ground/Shore.png",index:2,category:"background"},deep_water_tile:{name:"Deep Water Tile",spritePath:"/sprites/Ground/Shore.png",index:4,category:"background"},grass_tile_0:{name:"Grass Tile (Variant 0)",spritePath:"/sprites/Ground/TexturedGrass.png",index:0,category:"background"},grass_tile_1:{name:"Grass Tile (Variant 1)",spritePath:"/sprites/Ground/TexturedGrass.png",index:1,category:"background"},grass_tile_2:{name:"Grass Tile (Variant 2)",spritePath:"/sprites/Ground/TexturedGrass.png",index:2,category:"background"},grass_tile_3:{name:"Grass Tile (Variant 3)",spritePath:"/sprites/Ground/TexturedGrass.png",index:3,category:"background"},grass_tile_4:{name:"Grass Tile (Variant 4)",spritePath:"/sprites/Ground/TexturedGrass.png",index:4,category:"background"},grass_tile_5:{name:"Grass Tile (Variant 5)",spritePath:"/sprites/Ground/TexturedGrass.png",index:5,category:"background"},mine_entrance:{name:"Mine Entrance",spritePath:"/sprites/Buildings/Wood/Resources.png",index:10,category:"structure",properties:{interactable:!0,passable:!0,tileTypeRequired:["STONE"],spawning:{chance:.001,biomes:["STONE"]}}},windmill_frame_0:{name:"Windmill",spritePath:"/sprites/Buildings/Wood/Resources.png",index:3,category:"structure",properties:{animated:!0,animationFrames:[3,4,5],passable:!1,tileTypeRequired:["GRASS"],spawning:{chance:1e-4,biomes:["GRASS"]}}},food_market:{name:"Food Market",spritePath:"/sprites/Buildings/Wood/Market.png",index:4,category:"structure",properties:{interactable:!0,passable:!1,tileTypeRequired:["GRASS"],spawning:{chance:1e-4,biomes:["GRASS"]}}},butcher_market:{name:"Butcher Market",spritePath:"/sprites/Buildings/Wood/Market.png",index:11,category:"structure",properties:{interactable:!0,passable:!1,tileTypeRequired:["GRASS"],spawning:{chance:1e-4,biomes:["GRASS"]}}},armory_market:{name:"Armory Market",spritePath:"/sprites/Buildings/Wood/Market.png",index:5,category:"structure",properties:{interactable:!0,passable:!1,tileTypeRequired:["GRASS"],spawning:{chance:1e-4,biomes:["GRASS"]}}},cloth_market:{name:"Cloth Market",spritePath:"/sprites/Buildings/Wood/Market.png",index:7,category:"structure",properties:{interactable:!0,passable:!1,tileTypeRequired:["GRASS"],spawning:{chance:1e-4,biomes:["GRASS"]}}},dungeon_entrance:{name:"Dungeon Entrance",spritePath:"/sprites/Buildings/Wood/Resources.png",index:9,category:"structure",properties:{interactable:!0,passable:!0,tileTypeRequired:["STONE"],spawning:{chance:5e-4,biomes:["STONE"]}}},chicken_meat:{name:"Chicken Meat",spritePath:"/sprites/User Interface/Icons-Essentials.png",index:16,category:"inventory",properties:{maxStack:64}},pork:{name:"Pork",spritePath:"/sprites/User Interface/Icons-Essentials.png",index:17,category:"inventory",properties:{maxStack:64}},wool:{name:"Wool",spritePath:"/sprites/User Interface/Icons-Essentials.png",index:18,category:"inventory",properties:{maxStack:64}},mutton:{name:"Mutton",spritePath:"/sprites/User Interface/Icons-Essentials.png",index:19,category:"inventory",properties:{maxStack:64}},chicken:{name:"Chicken",spritePath:"/sprites/Animals/Chicken.png",index:0,category:"animal",properties:{health:20,animated:!0,animationFrames:[0,1,2,3],spawning:{chance:.001,biomes:["GRASS"]},dropItems:[{type:"chicken_meat",quantity:1}]}},pig:{name:"Pig",spritePath:"/sprites/Animals/Pig.png",index:0,category:"animal",properties:{health:35,animated:!0,animationFrames:[0,1,2,3],spawning:{chance:8e-4,biomes:["GRASS"]},dropItems:[{type:"pork",quantity:2}]}},sheep:{name:"Sheep",spritePath:"/sprites/Animals/Sheep.png",index:0,category:"animal",properties:{health:25,animated:!0,animationFrames:[0,1,2,3],spawning:{chance:.0012,biomes:["GRASS"]},dropItems:[{type:"wool",quantity:1},{type:"mutton",quantity:1}]}}};class v{loadAsset(){let t=Object.values(f).find(t=>{if(!t||"string"!=typeof t.name)return!1;let e=t.name.toLowerCase().replace(/\s+/g,"_");return e===this.type||this.type.includes(e)});t&&"string"==typeof t.spritePath?(this.asset=t,this.loadSprite(t.spritePath)):console.warn("No asset found for POI type: ".concat(this.type))}async loadSprite(t){try{this.sprite=new Image,this.sprite.src=(0,u.O)(t),await new Promise((e,i)=>{if(!this.sprite)return void i(Error("Sprite is null"));this.sprite.onload=()=>{this.isLoaded=!0,e()},this.sprite.onerror=()=>{i(Error("Failed to load POI sprite: ".concat(t)))}})}catch(t){console.error("Failed to load POI sprite for ".concat(this.type,":"),t)}}update(t){if(this.animated&&this.animationFrames.length>1){this.lastFrameTime+=1e3*t;let e=this.animationDuration/this.animationFrames.length;this.lastFrameTime>=e&&(this.lastFrameTime=0,this.currentFrame=(this.currentFrame+1)%this.animationFrames.length)}this.damage>0&&(this.type.includes("fire")||this.type.includes("flame"))}interact(t){if(!this.interactable)return{success:!1,message:"Cannot interact with ".concat(this.type)};switch(this.type){case"normal_chest":case"rare_chest":return this.handleChestInteraction();case"water_well":return this.handleWellInteraction();case"portal":return this.handlePortalInteraction();case"empty_notice_board":case"notice_board":return this.handleNoticeBoardInteraction();case"tombstone":return this.handleTombstoneInteraction();case"wheat_field_0":return this.handleWheatFieldInteraction();case"boat_vertical":case"boat_horizontal":return this.handleBoatInteraction();case"food_market":case"butcher_market":case"armory_market":case"cloth_market":return this.handleMarketInteraction();case"mine_entrance":case"dungeon_entrance":return this.handleEntranceInteraction();default:return{success:!1,message:"Unknown interaction type: ".concat(this.type)}}}handleChestInteraction(){let t="rare_chest"===this.type,e=[];return t?e.push({id:"item_".concat(Date.now(),"_1"),type:"gold_ingot",quantity:3},{id:"item_".concat(Date.now(),"_2"),type:"magic_potion",quantity:1},{id:"item_".concat(Date.now(),"_3"),type:"sword",quantity:1}):e.push({id:"item_".concat(Date.now(),"_1"),type:"copper_ingot",quantity:2},{id:"item_".concat(Date.now(),"_2"),type:"health_potion",quantity:2}),{success:!0,message:"Opened ".concat(t?"rare":"normal"," chest!"),items:e,openUI:"chest"}}handleWellInteraction(){return{success:!0,message:"You drink fresh water from the well. Health restored!",healthChange:25}}handlePortalInteraction(){return{success:!0,message:"You step through the portal...",teleportTo:{x:16*Math.floor(1e3*Math.random()),y:16*Math.floor(1e3*Math.random())}}}handleNoticeBoardInteraction(){return"empty_notice_board"===this.type?{success:!0,message:"The notice board is empty. You could post a message here.",openUI:"notice_board"}:{success:!0,message:"Reading the notices on the board...",openUI:"notice_board"}}handleTombstoneInteraction(){var t;return{success:!0,message:"You retrieve items from the grave...",items:null!=(t=this.customData.deathInventory)?t:[]}}handleWheatFieldInteraction(){return this.currentFrame>=3||!this.animated?{success:!0,message:"You harvest the wheat field!",items:[{id:"item_".concat(Date.now(),"_wheat"),type:"wheat",quantity:3}]}:{success:!1,message:"The wheat is not ready for harvest yet."}}handleBoatInteraction(){return{success:!0,message:"You board the boat. You can now travel on water!"}}handleMarketInteraction(){let t="Welcome to the market!";switch(this.type){case"food_market":t="Welcome to the food market!";break;case"butcher_market":t="Welcome to the butcher!";break;case"armory_market":t="Welcome to the armory!";break;case"cloth_market":t="Welcome to the cloth market!"}return{success:!0,message:t,openUI:"market"}}handleEntranceInteraction(){let t="mine_entrance"===this.type;return{success:!0,message:"You enter the ".concat(t?"mine":"dungeon","..."),teleportTo:{x:this.position.x,y:this.position.y+100}}}takeDamage(t){return this.health-=t,this.health<=0}getDropItems(){return this.dropItems.map(t=>({id:"item_".concat(Date.now(),"_").concat(Math.random().toString(36).substring(2,9)),type:t.type,quantity:t.quantity}))}render(t,e,i){var s;let r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:1;if(!this.isLoaded||!this.sprite||!this.asset)return;let a=this.animated?null!=(s=this.animationFrames[this.currentFrame])?s:0:"number"==typeof this.asset.index?this.asset.index:0,n=Math.floor(this.sprite.width/16),o=16*Math.floor(a/n);t.drawImage(this.sprite,a%n*16,o,16,16,e,i,16*r,16*r)}isAt(t){return this.position.x===t.x&&this.position.y===t.y}isDangerous(){return this.damage>0}constructor(t){var e,i,s,r,a,n;this.currentFrame=0,this.lastFrameTime=0,this.animationDuration=2e3,this.sprite=null,this.asset=null,this.isLoaded=!1,this.type=t.type,this.position=t.position,this.health=null!=(e=t.health)?e:100,this.interactable=t.interactable,this.passable=t.passable,this.damage=null!=(i=t.damage)?i:0,this.animated=null!=(s=t.animated)&&s,this.animationFrames=null!=(r=t.animationFrames)?r:[0],this.dropItems=null!=(a=t.dropItems)?a:[],this.customData=null!=(n=t.customData)?n:{},this.loadAsset()}}class I{getDefaultHealth(){switch(this.type){case"chicken":return 20;case"pig":return 35;case"sheep":default:return 25;case"monster":return 80;case"trader":return 50}}getDefaultAggressive(){return"monster"===this.type}getDefaultDropItems(){switch(this.type){case"chicken":return[{type:"chicken_meat",quantity:1}];case"pig":return[{type:"pork",quantity:2}];case"sheep":return[{type:"wool",quantity:1},{type:"mutton",quantity:1}];case"monster":return[{type:"monster_drop",quantity:1}];case"trader":return[{type:"gold_ingot",quantity:1}];default:return[]}}loadAsset(){let t=Object.values(f).find(t=>!!t&&"string"==typeof t.name&&t.name.toLowerCase()===this.type);t&&"string"==typeof t.spritePath?(this.asset=t,this.loadSprite(t.spritePath)):console.warn("No asset found for NPC type: ".concat(this.type))}async loadSprite(t){try{this.sprite=new Image,this.sprite.src=(0,u.O)(t),await new Promise((e,i)=>{if(!this.sprite)return void i(Error("Sprite is null"));this.sprite.onload=()=>{this.isLoaded=!0,e()},this.sprite.onerror=()=>{i(Error("Failed to load NPC sprite: ".concat(t)))}})}catch(t){console.error("Failed to load NPC sprite for ".concat(this.type,":"),t)}}update(t,e,i){"dead"!==this.state&&(this.updateAnimation(t),this.updateAI(t,e,i),this.updateMovement(t))}updateAnimation(t){var e,i;if((null==(i=this.asset)||null==(e=i.properties)?void 0:e.animated)!==!0)return;this.lastFrameTime+=1e3*t;let s=this.animationDuration/4;this.lastFrameTime>=s&&(this.lastFrameTime=0,this.currentFrame=(this.currentFrame+1)%4)}updateAI(t,e,i){let s=this.getDistanceToPosition(e),r=i.some(t=>(null==t?void 0:t.type)==="wheat");s<=this.detectionRange?this.aggressive&&"monster"===this.type?(this.state="attacking",this.target={...e}):r&&!this.aggressive?(this.state="following",this.target={...e}):this.aggressive&&!r?(this.state="fleeing",this.target=this.getFleePosition(e)):(this.state="idle",this.target=null):("following"===this.state||"attacking"===this.state||"fleeing"===this.state)&&(this.state="wandering",this.target=null),("idle"===this.state||"wandering"===this.state)&&(this.moveTimer+=1e3*t,this.moveTimer>=this.moveInterval&&(this.moveTimer=0,this.initiateRandomMovement()))}updateMovement(t){if(!this.target||"idle"===this.state)return;let e=this.movementSpeed*(1e3*t);"following"===this.state||"attacking"===this.state?this.moveTowardsTarget(e):"fleeing"===this.state?this.moveAwayFromTarget(e):"wandering"===this.state&&this.moveTowardsTarget(.5*e)}moveTowardsTarget(t){if(!this.target)return;let e=this.target.x-this.position.x,i=this.target.y-this.position.y,s=Math.sqrt(e*e+i*i);if(s>16){let r=e/s,a=i/s;this.position.x+=r*t,this.position.y+=a*t,this.updateDirectionFromMovement(r,a)}}moveAwayFromTarget(t){if(!this.target)return;let e=this.target.x-this.position.x,i=this.target.y-this.position.y,s=Math.sqrt(e*e+i*i);if(s<16*this.detectionRange){let r=-e/s,a=-i/s;this.position.x+=r*t,this.position.y+=a*t,this.updateDirectionFromMovement(r,a)}else this.state="wandering",this.target=null}updateDirectionFromMovement(t,e){Math.abs(t)>Math.abs(e)?this.direction=t>0?"right":"left":this.direction=e>0?"down":"up"}getDistanceToPosition(t){let e=t.x-this.position.x,i=t.y-this.position.y;return Math.sqrt(e*e+i*i)/16}getFleePosition(t){let e=this.position.x-t.x,i=this.position.y-t.y,s=Math.sqrt(e*e+i*i);return 0===s?{x:this.position.x+(Math.random()-.5)*160,y:this.position.y+(Math.random()-.5)*160}:{x:this.position.x+e/s*160,y:this.position.y+i/s*160}}initiateRandomMovement(){if(16*this.getDistanceToPosition(this.originalPosition)>80)this.target={...this.originalPosition},this.state="wandering";else{let t=Math.random()*Math.PI*2,e=3*Math.random()*16;this.target={x:this.position.x+Math.cos(t)*e,y:this.position.y+Math.sin(t)*e},this.state="wandering"}}takeDamage(t){return(this.health-=t,this.health<=0)?(this.state="dead",!0):(this.aggressive||"trader"===this.type||(this.state="fleeing"),!1)}getDropItems(){return this.dropItems.map(t=>({id:"item_".concat(Date.now(),"_").concat(Math.random().toString(36).substring(2,9)),type:t.type,quantity:t.quantity}))}render(t,e,i){let s=arguments.length>3&&void 0!==arguments[3]?arguments[3]:1;if(!this.isLoaded||!this.sprite||!this.asset||"dead"===this.state)return;let r=this.getFrameIndex(),a=Math.floor(this.sprite.width/16),n=16*Math.floor(r/a);t.drawImage(this.sprite,r%a*16,n,16,16,e,i,16*s,16*s),this.health<this.maxHealth&&this.renderHealthBar(t,e,i-8,s)}getFrameIndex(){return this.getDirectionOffset()+this.currentFrame}getDirectionOffset(){switch(this.direction){case"down":default:return 0;case"up":return 4;case"left":return 8;case"right":return 12}}renderHealthBar(t,e,i,s){let r=16*s,a=3*s,n=this.health/this.maxHealth;t.fillStyle="#FF0000",t.fillRect(e,i,r,a),t.fillStyle="#00FF00",t.fillRect(e,i,r*n,a),t.strokeStyle="#000000",t.lineWidth=1,t.strokeRect(e,i,r,a)}isAt(t){return 8>Math.abs(this.position.x-t.x)&&8>Math.abs(this.position.y-t.y)}isDead(){return"dead"===this.state}isHostile(){return this.aggressive&&"attacking"===this.state}canMoveTo(t){return 160>=Math.sqrt(Math.pow(t.x-this.originalPosition.x,2)+Math.pow(t.y-this.originalPosition.y,2))}constructor(t){var e,i,s,r,a;this.state="idle",this.direction="down",this.lastMoveTime=0,this.target=null,this.currentFrame=0,this.lastFrameTime=0,this.animationDuration=1e3,this.sprite=null,this.asset=null,this.isLoaded=!1,this.moveTimer=0,this.moveInterval=2e3,this.type=t.type,this.position={...t.position},this.originalPosition={...t.position},this.health=null!=(e=t.health)?e:this.getDefaultHealth(),this.maxHealth=this.health,this.aggressive=null!=(i=t.aggressive)?i:this.getDefaultAggressive(),this.movementSpeed=null!=(s=t.movementSpeed)?s:1,this.detectionRange=null!=(r=t.detectionRange)?r:5,this.dropItems=null!=(a=t.dropItems)?a:this.getDefaultDropItems(),this.loadAsset()}}class T{hashSeed(t){let e=0;for(let i=0;i<t.length;i++)e=(e<<5)-e+t.charCodeAt(i),e&=e;return Math.abs(e)}generateVillageStructures(t,e,i,s){let r=[],a="".concat(t,",").concat(e);if(s.has(a))return[];let n=16*t/1e3,o=16*e/1e3,l=this.villageNoise(n,o);if(l>this.VILLAGE_THRESHOLD&&"GRASS"===i){console.log("\uD83C\uDFD8️ Generating village at tile (".concat(t,", ").concat(e,")"));let i=this.generateVillage(t,e,s,(t,e)=>"GRASS");r.push(...i),console.log("\uD83C\uDFD8️ Village generated ".concat(i.length," structures"))}if("STONE"===i&&this.mineNoise(3*n,3*o)>.95){let i=this.generateMineOrDungeon(t,e,s);i&&r.push(i)}if("GRASS"===i&&l<this.VILLAGE_THRESHOLD){let i=this.generateAnimal(t,e,s);i&&r.push(i)}return r}generateVillage(t,e,i){let s=arguments.length>3&&void 0!==arguments[3]?arguments[3]:()=>"GRASS",r=[],a="village_".concat(Math.floor(t/20),"_").concat(Math.floor(e/20));if(i.has(a))return[];let n="".concat(t,",").concat(e);if(!i.has(n)){let a=s(t,e);if(this.isValidPOITerrain(a)){let s=this.createStructurePOI("windmill_frame_0",{x:16*t,y:16*e});s&&(r.push(s),i.set(n,s),console.log("Generated windmill at tile (".concat(t,", ").concat(e,")")))}}for(let a of[{type:"food_market",x:t+8,y:e},{type:"butcher_market",x:t-8,y:e},{type:"armory_market",x:t,y:e+8},{type:"cloth_market",x:t,y:e-8}]){let t="".concat(a.x,",").concat(a.y);if(!i.has(t)){let e=s(a.x,a.y);if(this.isValidPOITerrain(e)){let e={x:16*a.x,y:16*a.y},s=this.createStructurePOI(a.type,e);s&&(r.push(s),i.set(t,s),console.log("Generated ".concat(a.type," at tile (").concat(a.x,", ").concat(a.y,")")))}}}let o=["chicken","pig","sheep"];for(let a of[{x:t+4,y:e+4},{x:t-4,y:e+4},{x:t+4,y:e-4},{x:t-4,y:e-4},{x:t+6,y:e+2},{x:t-6,y:e-2}]){let t="".concat(a.x,",").concat(a.y);if(!i.has(t)){let e=s(a.x,a.y);if(this.isValidNPCTerrain(e)){let e=o[Math.floor(Math.random()*o.length)];if(e){let s={x:16*a.x,y:16*a.y},n=this.createAnimalNPC(e,s);n&&(r.push(n),i.set(t,n),console.log("Generated ".concat(e," at tile (").concat(a.x,", ").concat(a.y,")")))}}}}return i.set(a,{type:"village_marker",position:{x:16*t,y:16*e}}),r}generateMineOrDungeon(t,e,i){let s="".concat(t,",").concat(e);if(i.has(s))return null;for(let s=-15;s<=15;s++)for(let r=-15;r<=15;r++){if(0===s&&0===r)continue;let a="".concat(t+s,",").concat(e+r),n=i.get(a);if(n&&("mine_entrance"===n.type||"dungeon_entrance"===n.type))return null}if(Math.random()>.3)return null;let r=.7>Math.random()?"mine_entrance":"dungeon_entrance",a=this.createStructurePOI(r,{x:16*t,y:16*e});return a&&i.set(s,a),a}generateAnimal(t,e,i){let s="".concat(t,",").concat(e);if(i.has(s))return null;let r=16*t,a=16*e;if(.95>this.animalNoise(r/500,a/500))return null;let n=["chicken","pig","sheep"],o=n[Math.floor(Math.random()*n.length)];if(!o)return null;let l=this.createAnimalNPC(o,{x:r,y:a});return l&&i.set(s,l),l}createStructurePOI(t,e){try{let i=new v({type:t,position:e,interactable:!0,passable:t.includes("entrance"),animated:"windmill_frame_0"===t});return{type:t,position:e,poi:i}}catch(e){return console.warn("Failed to create POI structure ".concat(t,":"),e),null}}createAnimalNPC(t,e){try{let i=new I({type:t,position:e,aggressive:!1});return{type:t,position:e,npc:i}}catch(e){return console.warn("Failed to create animal NPC ".concat(t,":"),e),null}}getVillageCenter(t,e){return this.villageNoise(t/1e3,e/1e3)>this.VILLAGE_THRESHOLD?{x:20*Math.floor(Math.floor(t/16)/20)*16,y:20*Math.floor(Math.floor(e/16)/20)*16}:null}isValidPOITerrain(t){return"DEEP_WATER"!==t&&"SHALLOW_WATER"!==t&&"STONE"!==t}isValidNPCTerrain(t){return"DEEP_WATER"!==t&&"STONE"!==t}constructor(t){this.VILLAGE_THRESHOLD=.85;let e=this.hashSeed(null!=t?t:"default");this.villageNoise=(0,l.fu)(()=>1.1*e),this.structureNoise=(0,l.fu)(()=>2.3*e),this.animalNoise=(0,l.fu)(()=>3.7*e),this.mineNoise=(0,l.fu)(()=>4.9*e)}}class w{generateChunk(t,e,i){let s=[],r=[];for(let a=0;a<i;a++){let n=[];for(let s=0;s<i;s++){let o=t*i+s,l=e*i+a,h=this.generateHeight(o,l),c=this.generateTemperature(o,l),u=this.generateHumidity(o,l),{value:p,flowDirection:g}=this.generateRiver(o,l,h),d=this.getTileTypeFromClimate(h,c,u,p,g),m={x:o,y:l,value:d,height:h,temperature:c,humidity:u,riverValue:p,flowDirection:g};"FOREST"===d?m.trees=this.generateTrees(o,l,1):"GRASS"===d&&(m.trees=this.generateTrees(o,l,.05)),"SAND"===d&&(m.cactus=this.generateCactus(o,l,.05));let y=this.getSpriteIdForTile(d,o,l);y&&(m.spriteId=y);let S=this.villageGenerator.generateVillageStructures(o,l,d,this.villageStructures);S.length>0&&(m.villageStructures=S,r.push(...S)),n.push(m)}s.push(n)}return s}generateHeight(t,e){let i=.02*t,s=.02*e,r=.5*this.heightNoise(i,s);return r+=.25*this.heightNoise(2*i,2*s),r+=.125*this.heightNoise(4*i,4*s),r+=.0625*this.heightNoise(8*i,8*s),r=Math.pow(r=(r+1)/2,1.2)}generateTemperature(t,e){let i=.01*t,s=.01*e,r=.5*this.temperatureNoise(i,s);return r+=.25*this.temperatureNoise(2*i,2*s)+.125*this.temperatureNoise(4*i,4*s),r=(r+1)/2}generateHumidity(t,e){let i=.015*t,s=.015*e,r=.5*this.humidityNoise(i,s);return r+=.25*this.humidityNoise(2*i,2*s)+.125*this.humidityNoise(4*i,4*s),r=(r+1)/2}generateRiver(t,e,i){let s=.03*t,r=.03*e,a=.5*this.riverNoise(s,r);a+=.25*this.riverNoise(2*s,2*r)+.125*this.riverNoise(4*s,4*r);let n=.5*this.riverPathNoise(.05*t,.05*e);n+=.25*this.riverPathNoise(.05*t*2,.05*e*2)+.125*this.riverPathNoise(.05*t*4,.05*e*4),n=(n+1)/2;let o=this.calculateFlowDirection(t,e,i);return a*=Math.pow(1-Math.abs(i-.3),2)*(.5+.5*n),{value:a+=(Math.random()-.5)*.05,flowDirection:o}}calculateFlowDirection(t,e,i){let s=i,r=0;return[{dx:1,dy:0},{dx:1,dy:1},{dx:0,dy:1},{dx:-1,dy:1},{dx:-1,dy:0},{dx:-1,dy:-1},{dx:0,dy:-1},{dx:1,dy:-1}].forEach((i,a)=>{let n=this.generateHeight(t+i.dx,e+i.dy);n<s&&(s=n,r=Math.PI/4*a)}),r}getTileTypeFromClimate(t,e,i,s,r){if(s>.75&&t>.2&&t<.8){let t=.1*Math.sin(2*r);if(Math.abs(s-.75)<.1+t)return"RIVER";if(Math.abs(s-.75)<.1+t+.05)return"SAND"}return t<.35?t<.3?"DEEP_WATER":"SHALLOW_WATER":e<.2?t>.8?"SNOW":t>.7?"STONE":t>.65?"COBBLESTONE":i>.6?"FOREST":i>.3?"GRASS":"STONE":e<.4?t>.7?"SNOW":t>.65?"STONE":t>.6?"COBBLESTONE":i>.7?"FOREST":i>.4?"GRASS":i>.2?"SAND":"STONE":e<.7?t>.6?"STONE":t>.55?"COBBLESTONE":i>.7?"FOREST":i>.4?"GRASS":t<.25&&i>.3?.7>Math.random()?"CLAY":"MUD":t<.25||i<.3?"SAND":"GRASS":t>.5?"STONE":t>.45?"COBBLESTONE":i>.6?"GRASS":t<.25?i>.3?.8>Math.random()?"CLAY":"MUD":"SAND":i<.5||.7>Math.random()?"SAND":"GRASS"}generateTile(t,e){let i=this.generateHeight(t,e),s=this.generateTemperature(t,e),r=this.generateHumidity(t,e),{value:a,flowDirection:n}=this.generateRiver(t,e,i),o=this.getTileTypeFromClimate(i,s,r,a,n),l={x:t,y:e,value:o,height:i,temperature:s,humidity:r,riverValue:a,flowDirection:n};"FOREST"===o?l.trees=this.generateTrees(t,e,1):"GRASS"===o&&(l.trees=this.generateTrees(t,e,.05)),"SAND"===o&&(l.cactus=this.generateCactus(t,e,.05));let h=this.getSpriteIdForTile(o,t,e);return h&&(l.spriteId=h),l}generateTrees(t,e){let i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:1,s=[];if(Math.random()>i)return s;let r=t*w.TILE_SIZE+w.TILE_SIZE/2,a=e*w.TILE_SIZE+w.TILE_SIZE/2,n=Math.random(),o=d.YOUNG;return n<.1?o=d.FULL:n<.3&&(o=d.TALL),s.push(new m({x:r,y:a,initialStage:o,growthTimePerStage:36e5})),s}generateCactus(t,e){let i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:1,s=[];if(Math.random()>i)return s;let r=t*w.TILE_SIZE+w.TILE_SIZE/2,a=e*w.TILE_SIZE+w.TILE_SIZE/2,n=[y.VARIANT_1,y.VARIANT_2,y.VARIANT_3],o=n[Math.floor(Math.random()*n.length)],l=Math.random(),h=0;return l<.2&&(h=1,o===y.VARIANT_2&&l<.1&&(h=2)),s.push(new S({x:r,y:a,variant:o,initialStage:h,growthTimePerStage:6e5})),s}getSpriteIdForTile(t,e,i){switch(t){case"GRASS":if(void 0!==e&&void 0!==i){let t=Math.abs(31*e+17*i)%6,s=Math.floor(t/3);return"/sprites/Ground/TexturedGrass.png#".concat(t%3,",").concat(s)}return"/sprites/Ground/TexturedGrass.png#0,0";case"SAND":return"/sprites/Ground/Shore.png#0,0";case"SHALLOW_WATER":return"/sprites/Ground/Shore.png#2,0";case"DEEP_WATER":return"/sprites/Ground/Shore.png#4,0";default:return}}constructor(t){this.villageStructures=new Map,this.seed=null!=t?t:Math.random().toString(36).substring(2);let e=c()(this.seed);this.heightNoise=(0,l.fu)(e),this.temperatureNoise=(0,l.fu)(e),this.humidityNoise=(0,l.fu)(e),this.riverNoise=(0,l.fu)(e),this.riverPathNoise=(0,l.fu)(e),this.villageGenerator=new T(this.seed)}}w.TILE_SIZE=16;class x{setMoveCallback(t){this.onMoveCallback=t}setDirectionChangeCallback(t){this.onDirectionChangeCallback=t}canMoveToTile(t){if(!t||"DEEP_WATER"===t.value||"STONE"===t.value||t.trees&&t.trees.length>0&&t.trees.some(t=>t.getHealth()>0)||t.cactus&&t.cactus.length>0&&t.cactus.some(t=>t.getHealth()>0))return!1;if(t.villageStructures&&t.villageStructures.length>0){for(let e of t.villageStructures)if(e.poi&&!e.poi.passable||e.npc&&!e.npc.isDead())return!1}return!0}canMoveFromMud(){return Math.random()<1/3}canMoveFromSnow(){return Math.random()<1/4}canMoveFromShallowWater(){return Math.random()<1/3}update(t,e){var i,s,r,a;if(this.moveCooldown>0&&(this.moveCooldown-=16,this.moveCooldown>0))return;let n=this.world.getTile(t.position.x/this.TILE_SIZE,t.position.y/this.TILE_SIZE);if((null==n?void 0:n.value)==="MUD"&&!this.canMoveFromMud()||(null==n?void 0:n.value)==="SNOW"&&!this.canMoveFromSnow()||(null==n?void 0:n.value)==="SHALLOW_WATER"&&!this.canMoveFromShallowWater())return;let o=!1,l=!1,h=null,c={...t.position};if(e.wasKeyJustPressed("up")||e.isKeyPressed("up")?(c.y-=this.TILE_SIZE,o=!0,h="up"):e.wasKeyJustPressed("down")||e.isKeyPressed("down")?(c.y+=this.TILE_SIZE,o=!0,h="down"):e.wasKeyJustPressed("left")||e.isKeyPressed("left")?(c.x-=this.TILE_SIZE,o=!0,h="left"):(e.wasKeyJustPressed("right")||e.isKeyPressed("right"))&&(c.x+=this.TILE_SIZE,o=!0,h="right"),o){let e=this.world.getTile(c.x/this.TILE_SIZE,c.y/this.TILE_SIZE);if(this.canMoveToTile(e))t.position=c,l=!0;else{let t="".concat(null!=(r=null==e?void 0:e.value)?r:"UNKNOWN"," tile");if(null==e||null==(i=e.trees)?void 0:i.some(t=>t.getHealth()>0))t+=" (blocked by tree)";else if(null==e||null==(s=e.cactus)?void 0:s.some(t=>t.getHealth()>0))t+=" (blocked by cactus)";else if(null==e?void 0:e.villageStructures){let i=e.villageStructures.filter(t=>t.poi&&!t.poi.passable||t.npc&&!t.npc.isDead());if(i.length>0){let e=i.map(t=>t.poi?t.poi.type:t.npc?t.npc.type:"unknown").join(", ");t+=" (blocked by ".concat(e,")")}}console.log("Movement blocked - cannot move to ".concat(t))}h&&this.onDirectionChangeCallback&&this.onDirectionChangeCallback(h,l)}if(l){t.position.x=Math.round(t.position.x/this.TILE_SIZE)*this.TILE_SIZE,t.position.y=Math.round(t.position.y/this.TILE_SIZE)*this.TILE_SIZE,this.moveCooldown=this.moveDelay;let e=this.world.getTile(t.position.x/this.TILE_SIZE,t.position.y/this.TILE_SIZE),i=null!=(a=null==e?void 0:e.value)?a:"UNKNOWN";if((null==e?void 0:e.trees)&&e.trees.length>0){let t=e.trees[0];i+=" (Tree: ".concat(null==t?void 0:t.getHealth(),"/").concat(null==t?void 0:t.getMaxHealth()," HP)")}if((null==e?void 0:e.cactus)&&e.cactus.length>0){let t=e.cactus[0];i+=" (Cactus: ".concat(null==t?void 0:t.getHealth(),"/").concat(null==t?void 0:t.getMaxHealth()," HP)")}if((null==e?void 0:e.villageStructures)&&e.villageStructures.length>0){let t=e.villageStructures.map(t=>t.poi?t.poi.type:t.npc?"".concat(t.npc.type," NPC"):"unknown").join(", ");i+=" (Structures: ".concat(t,")")}console.log("Current tile:",i),this.onMoveCallback&&h&&this.onMoveCallback(h)}}constructor(t){this.TILE_SIZE=w.TILE_SIZE,this.moveCooldown=0,this.moveDelay=120,this.world=t}}class E{getTile(t,e){var i,s;if(!(t<0)&&!(e<0)&&!(t>=this.size)&&!(e>=this.size)){if(null!=(i=this.tiles)[e]||(i[e]=[]),!this.tiles[e][t]){let i=this.chunkX*this.size+t,s=this.chunkY*this.size+e;this.tiles[e][t]=this.generator.generateTile(i,s)}return this.tiles[e][t]}}setTile(t,e,i){var s,r;if(t<0||e<0||t>=this.size||e>=this.size)return;null!=(s=this.tiles)[e]||(s[e]=[]),this.tiles[e][t]=i;let a="".concat(t,",").concat(e);this.entityData.modifiedTiles.set(a,i)}addTree(t,e,i){let s="".concat(t,",").concat(e);this.entityData.trees.set(s,i)}removeTree(t,e){let i="".concat(t,",").concat(e);this.entityData.trees.delete(i)}getTree(t,e){let i="".concat(t,",").concat(e);return this.entityData.trees.get(i)}addCactus(t,e,i){let s="".concat(t,",").concat(e);this.entityData.cactus.set(s,i)}removeCactus(t,e){let i="".concat(t,",").concat(e);this.entityData.cactus.delete(i)}getCactus(t,e){let i="".concat(t,",").concat(e);return this.entityData.cactus.get(i)}getAllTrees(){return this.entityData.trees}getAllCactus(){return this.entityData.cactus}getModifiedTiles(){return this.entityData.modifiedTiles}hasModifications(){return this.entityData.modifiedTiles.size>0||this.entityData.trees.size>0||this.entityData.cactus.size>0}constructor(t,e,i,s,r){this.chunkX=t,this.chunkY=e,this.size=i,this.tiles=s,this.generator=r,this.entityData={trees:new Map,cactus:new Map,modifiedTiles:new Map}}}var _=i(6311);class P{setAnimationSystem(t){this.animationSystem=t}invalidateCache(){this.cacheValid=!1}update(t,e,i){this.updateDirtRegeneration(t),this.updateVillageStructures(t,e,i)}updateDirtRegeneration(t){for(let[i,s]of this.visibleTileCache)if("DIRT"===s.value){var e;null!=s.dirtTimer||(s.dirtTimer=0),s.dirtTimer+=1e3*t,s.dirtTimer>=3e4&&(s.value="GRASS",s.dirtTimer=void 0,this.invalidateCache(),console.log("DIRT tile regenerated to GRASS at (".concat(s.x,", ").concat(s.y,")")))}}updateVillageStructures(t,e,i){for(let[s,r]of this.visibleTileCache)if(r.villageStructures){for(let s of r.villageStructures)if(s.poi&&s.poi.update(t),s.npc&&!s.npc.isDead()){let r=null!=e?e:{x:0,y:0},a=null!=i?i:[];s.npc.update(t,r,a)}}}render(t,e){for(let[i,s]of(this.lastCameraX===e.position.x&&this.lastCameraY===e.position.y&&this.lastViewWidth===e.viewWidth&&this.lastViewHeight===e.viewHeight&&this.cacheValid||(this.updateVisibleTileCache(e,t),this.lastCameraX=e.position.x,this.lastCameraY=e.position.y,this.lastViewWidth=e.viewWidth,this.lastViewHeight=e.viewHeight,this.cacheValid=!0),this.visibleTileCache)){let r=i.split(",").map(Number);if(2!==r.length||void 0===r[0]||void 0===r[1])continue;let a=r[0],n=r[1],o=e.worldToScreen(a*this.TILE_SIZE,n*this.TILE_SIZE);this.renderTile(t,s,o.x,o.y)}}updateVisibleTileCache(t,e){this.visibleTileCache.clear();let i=Math.floor(t.position.x/this.TILE_SIZE)-2,s=Math.floor(t.position.y/this.TILE_SIZE)-2,r=Math.ceil(e.canvas.width/this.TILE_SIZE)+4,a=Math.ceil(e.canvas.height/this.TILE_SIZE)+4;for(let t=0;t<=a;t++)for(let e=0;e<=r;e++){let r=i+e,a=s+t,n=this.getTile(r,a),o="".concat(r,",").concat(a);this.visibleTileCache.set(o,n)}}renderTile(t,e,i,s){let r=i-this.TILE_SIZE/2,a=s-this.TILE_SIZE/2;if(t.fillStyle=this.getTileColor(e.value),t.fillRect(r+1,a+1,this.TILE_SIZE-2,this.TILE_SIZE-2),e.spriteId&&this.spriteGenerator.renderSprite(t,e.spriteId,r+1,a+1),e.villageStructures){for(let i of e.villageStructures)i.poi&&i.poi.render(t,r+1,a+1);for(let i of e.villageStructures)i.npc&&!i.npc.isDead()&&i.npc.render(t,r+1,a+1)}}getTileColor(t){switch(t){case"DEEP_WATER":return"#00008B";case"SHALLOW_WATER":return"#4169E1";case"RIVER":return"#1E90FF";case"SAND":return"#F4A460";case"GRASS":return"#90EE90";case"MUD":return"#8B4513";case"DIRT":return"#CD853F";case"CLAY":return"#CD7F32";case"FOREST":return"#006400";case"GRAVEL":return"#B8B8B8";case"COBBLESTONE":return"#A9A9A9";case"STONE":return"#808080";case"SNOW":return"#FFFFFF";case"PLAYER":return"red";default:return"#000000"}}chunkKey(t,e){return"".concat(t,",").concat(e)}getOrCreateChunk(t,e){let i=this.chunkKey(t,e),s=this.chunks.get(i);if(!s){let r=this.generator.generateChunk(t,e,P.CHUNK_SIZE);s=new E(t,e,P.CHUNK_SIZE,r,this.generator),this.chunks.set(i,s),this.animationSystem&&(this.registerChunkTrees(s,r),this.registerChunkCactus(s,r),this.registerChunkVillageStructures(s,r))}return s}registerChunkTrees(t,e){if(this.animationSystem){for(let t of e)for(let e of t)if(e.trees)for(let t of e.trees){let i="".concat(e.x,",").concat(e.y);this.animationSystem.addTree(i,t)}}}registerChunkCactus(t,e){if(this.animationSystem){for(let t of e)for(let e of t)if(e.cactus)for(let t of e.cactus){let i="".concat(e.x,",").concat(e.y);this.animationSystem.addCactus(i,t)}}}registerChunkVillageStructures(t,e){if(this.animationSystem){for(let t of e)for(let e of t)if(e.villageStructures)for(let t of e.villageStructures){if(t.npc){let i="".concat(e.x,",").concat(e.y);console.log("Village NPC ".concat(t.type," registered at ").concat(i))}t.poi&&console.log("Village POI ".concat(t.type," registered at ").concat(e.x,",").concat(e.y))}}}getTile(t,e){let i=Math.floor(t/P.CHUNK_SIZE),s=Math.floor(e/P.CHUNK_SIZE),r=(t%P.CHUNK_SIZE+P.CHUNK_SIZE)%P.CHUNK_SIZE,a=(e%P.CHUNK_SIZE+P.CHUNK_SIZE)%P.CHUNK_SIZE,n=this.getOrCreateChunk(i,s),o=n.getTile(r,a);return o||(o=this.generator.generateTile(t,e),n.setTile(r,a,o)),o}setTile(t,e,i){let s=Math.floor(t/P.CHUNK_SIZE),r=Math.floor(e/P.CHUNK_SIZE),a=(t%P.CHUNK_SIZE+P.CHUNK_SIZE)%P.CHUNK_SIZE,n=(e%P.CHUNK_SIZE+P.CHUNK_SIZE)%P.CHUNK_SIZE,o=this.getOrCreateChunk(s,r),l=o.getTile(a,n);l&&(l.prevValue=l.value,l.value=i,l.interacted=!0,o.setTile(a,n,l),this.invalidateCache())}setPlayerPosition(t,e,i,s){let r=this.getTile(t,e);if(r){var a;r.value=null!=(a=r.prevValue)?a:this.generator.generateTile(t,e).value,r.interacted=!1}let n=this.getTile(i,s);n&&(n.prevValue=n.value,n.value="PLAYER",n.interacted=!0),this.invalidateCache()}getVisibleChunks(t,e,i,s){let r=w.TILE_SIZE,a=Math.floor(t/r),n=Math.floor(e/r),o=Math.ceil((t+i)/r),l=Math.ceil((e+s)/r),h=[];for(let t=Math.floor(n/P.CHUNK_SIZE);t<=Math.floor(l/P.CHUNK_SIZE);t++)for(let e=Math.floor(a/P.CHUNK_SIZE);e<=Math.floor(o/P.CHUNK_SIZE);e++)h.push(this.getOrCreateChunk(e,t));return h}constructor(t){this.TILE_SIZE=w.TILE_SIZE,this.chunks=new Map,this.visibleTileCache=new Map,this.lastCameraX=0,this.lastCameraY=0,this.lastViewWidth=0,this.lastViewHeight=0,this.cacheValid=!1,this.generator=null!=t?t:new w,this.spriteGenerator=new _.N}}P.CHUNK_SIZE=16;class C{update(t){let e=w.TILE_SIZE,i=Math.round(t.x/e)*e,s=Math.round(t.y/e)*e;this.playerPosition={x:i,y:s},this.position={x:i-this.canvas.width/2,y:s-this.canvas.height/2},this.viewWidth=this.canvas.width,this.viewHeight=this.canvas.height}worldToScreen(t,e){return{x:t-this.position.x,y:e-this.position.y}}screenToWorld(t,e){return{x:t+this.position.x,y:e+this.position.y}}constructor(t){this.playerPosition={x:0,y:0},this.TILE_SIZE=w.TILE_SIZE,this.canvas=t,this.position={x:0,y:0},this.viewWidth=t.width,this.viewHeight=t.height}}class M{addTree(t,e){this.trees.set("".concat(t,"_").concat(e.x,"_").concat(e.y),e),this.animatedEntities.add(e)}removeTree(t,e){let i="".concat(t,"_").concat(e.x,"_").concat(e.y);this.trees.delete(i),this.animatedEntities.delete(e)}addCactus(t,e){this.cactus.set("".concat(t,"_").concat(e.x,"_").concat(e.y),e),this.animatedEntities.add(e)}removeCactus(t,e){let i="".concat(t,"_").concat(e.x,"_").concat(e.y);this.cactus.delete(i),this.animatedEntities.delete(e)}addAnimatedEntity(t){this.animatedEntities.add(t)}removeAnimatedEntity(t){this.animatedEntities.delete(t)}update(t){for(let e of this.animatedEntities)e.update(t)}render(t,e){let i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:1;for(let s of this.getVisibleTrees(e)){let r=Math.floor(s.x/16),a=Math.floor(s.y/16),n=16*r,o=16*a,l=e.worldToScreen(n,o),h=l.x-8+1,c=l.y-8+1;h>=-16&&h<=t.canvas.width+16&&c>=-16&&c<=t.canvas.height+16&&s.renderAtScreenPosition(t,h,c,i)}for(let s of this.getVisibleCactus(e)){let r=Math.floor(s.x/16),a=Math.floor(s.y/16),n=16*r,o=16*a,l=e.worldToScreen(n,o),h=l.x-8+1,c=l.y-8+1;h>=-16&&h<=t.canvas.width+16&&c>=-16&&c<=t.canvas.height+16&&s.renderAtScreenPosition(t,h,c,i)}}getVisibleTrees(t){let e=t.position.x-32,i=t.position.y-32,s=t.position.x+t.viewWidth+32,r=t.position.y+t.viewHeight+32;return this.getTreesInArea(e,i,s,r)}getVisibleCactus(t){let e=t.position.x-32,i=t.position.y-32,s=t.position.x+t.viewWidth+32,r=t.position.y+t.viewHeight+32;return this.getCactusInArea(e,i,s,r)}getTreesInArea(t,e,i,s){let r=[];for(let a of this.trees.values())a.x>=t&&a.x<=i&&a.y>=e&&a.y<=s&&r.push(a);return r}getCactusInArea(t,e,i,s){let r=[];for(let a of this.cactus.values())a.x>=t&&a.x<=i&&a.y>=e&&a.y<=s&&r.push(a);return r}getAllTrees(){return Array.from(this.trees.values())}getAllCactus(){return Array.from(this.cactus.values())}getTreeCount(){return this.trees.size}getCactusCount(){return this.cactus.size}getAnimatedEntityCount(){return this.animatedEntities.size}clear(){this.trees.clear(),this.cactus.clear(),this.animatedEntities.clear()}constructor(){this.trees=new Map,this.cactus=new Map,this.animatedEntities=new Set}}class k{addItem(t){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:1;for(let s=0;s<this.maxSlots;s++){let r=this.items[s];if(r&&r.type===t){var i;let a=(null!=(i=r.maxStack)?i:64)-r.quantity;if(a>0){let i=Math.min(e,a);if(r.quantity+=i,e-=i,console.log("Added ".concat(i," ").concat(t," to slot ").concat(s+1,". New quantity: ").concat(r.quantity)),e<=0)return this.logInventoryState(),!0}}}for(;e>0;){let i=this.items.findIndex(t=>null===t);if(-1===i)return console.log("Inventory full! Could not add ".concat(e," ").concat(t)),!1;let s=this.getMaxStackSize(t),r=Math.min(e,s);this.items[i]={id:this.generateItemId(),type:t,quantity:r,maxStack:s},e-=r,console.log("Added ".concat(r," ").concat(t," to slot ").concat(i+1))}return this.logInventoryState(),!0}removeItem(t){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:1,i=e;for(let s=0;s<this.maxSlots;s++){let r=this.items[s];if(r&&r.type===t){let a=Math.min(i,r.quantity);if(r.quantity-=a,i-=a,r.quantity<=0&&(this.items[s]=null),i<=0)return console.log("Removed ".concat(e," ").concat(t," from inventory")),this.logInventoryState(),!0}}return console.log("Could not remove ".concat(e," ").concat(t,". Only removed ").concat(e-i)),this.logInventoryState(),!1}selectSlot(t){if(t>=0&&t<this.maxSlots){this.selectedSlot=t;let e=this.items[t];e?console.log("Selected slot ".concat(t+1,": ").concat(e.quantity,"x ").concat(e.type)):console.log("Selected slot ".concat(t+1,": Empty"))}}getSelectedItem(){var t;return null!=(t=this.items[this.selectedSlot])?t:null}getSelectedSlot(){return this.selectedSlot}getItem(t){if(t>=0&&t<this.maxSlots){var e;return null!=(e=this.items[t])?e:null}return null}isEmpty(){return this.items.every(t=>null===t)}getItemCount(t){return this.items.filter(e=>(null==e?void 0:e.type)===t).reduce((t,e)=>{var i;return t+(null!=(i=null==e?void 0:e.quantity)?i:0)},0)}logInventoryState(){console.log("=== INVENTORY STATE ==="),this.items.forEach((t,e)=>{let i=e===this.selectedSlot?"→":" ";t?console.log("".concat(i," Slot ").concat(e+1,": ").concat(t.quantity,"x ").concat(t.type)):console.log("".concat(i," Slot ").concat(e+1,": Empty"))}),console.log("=====================")}generateItemId(){return"item_".concat(Date.now(),"_").concat(Math.random().toString(36).substring(2,9))}getMaxStackSize(t){var e;return null!=(e=({wood:64,cactus:64,stone:64})[t])?e:64}constructor(){this.selectedSlot=0,this.maxSlots=9,this.items=Array(9).fill(null)}}class A{setPosition(t){this.position={...t}}setDirection(t){this.lastDirection=t}getFacingPosition(t){switch(this.lastDirection){case"up":return{x:this.position.x,y:this.position.y-t};case"down":default:return{x:this.position.x,y:this.position.y+t};case"left":return{x:this.position.x-t,y:this.position.y};case"right":return{x:this.position.x+t,y:this.position.y}}}takeDamage(t){this.health=Math.max(0,this.health-t),console.log("Player took ".concat(t," damage. Health: ").concat(this.health,"/").concat(this.maxHealth))}heal(t){this.health=Math.min(this.maxHealth,this.health+t),console.log("Player healed ".concat(t,". Health: ").concat(this.health,"/").concat(this.maxHealth))}addToInventory(t){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:1;return this.inventory.addItem(t,e)}removeFromInventory(t){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:1;return this.inventory.removeItem(t,e)}selectInventorySlot(t){this.inventory.selectSlot(t)}getSelectedItem(){return this.inventory.getSelectedItem()}getSelectedSlot(){return this.inventory.getSelectedSlot()}getInventoryItems(){let t=[];for(let e=0;e<9;e++)t.push(this.inventory.getItem(e));return t}openInventory(){console.log("=== PLAYER INVENTORY ==="),this.inventory.logInventoryState()}getHealthPercentage(){return this.health/this.maxHealth}isDead(){return this.health<=0}constructor(t){var e,i;this.lastDirection="down",this.position={...t.position},this.health=null!=(e=t.health)?e:100,this.maxHealth=this.health,this.attackDamage=null!=(i=t.attackDamage)?i:5,this.inventory=new k}}class F{async loadSprites(){try{for(let t of["default_item_box","highlighted_item_box","box_selector"]){let e=f[t];if(e){let i=new Image;i.src=(0,u.O)(e.spritePath),await new Promise((t,s)=>{i.onload=()=>t(),i.onerror=()=>s(Error("Failed to load ".concat(e.spritePath)))}),this.sprites.set(t,i)}}for(let t of Object.values(f).filter(t=>"inventory"===t.category))if(!this.sprites.has(t.spritePath)){let e=new Image;e.src=(0,u.O)(t.spritePath),await new Promise((i,s)=>{e.onload=()=>i(),e.onerror=()=>s(Error("Failed to load ".concat(t.spritePath)))}),this.sprites.set(t.spritePath,e)}this.imagesLoaded=!0,console.log("Inventory UI sprites loaded successfully")}catch(t){console.error("Failed to load inventory UI sprites:",t)}}render(t,e,i,s){if(!this.imagesLoaded)return;let r=t.canvas.width-this.config.marginFromEdge-this.config.slotSize,a=this.config.marginFromTop;for(let e=0;e<this.config.slotsPerColumn;e++){var n;let o=a+e*(this.config.slotSize+this.config.slotSpacing),l=null!=(n=i[e])?n:null,h=e===s;this.renderSlot(t,r,o,l,h,e+1)}}renderSlot(t,e,i,s,r,a){if(this.renderSprite(t,r?"highlighted_item_box":"default_item_box",0,e,i,this.config.slotSize,this.config.slotSize),r&&this.renderSprite(t,"box_selector",0,e-2,i-2,this.config.slotSize+4,this.config.slotSize+4),s){let r=this.getItemAsset(s.type);if(r){let a=Math.floor(.7*this.config.slotSize),n=e+(this.config.slotSize-a)/2,o=i+(this.config.slotSize-a)/2;this.renderSprite(t,s.type,r.index,n,o,a,a),s.quantity>1&&this.renderQuantity(t,e,i,s.quantity)}}this.renderSlotNumber(t,e,i,a)}renderSprite(t,e,i,s,r,a,n){let o=f[e];if(!o)return;let l=this.sprites.get(o.spritePath);if(!l)return;let h=Math.floor(l.width/16),c=16*Math.floor(i/h);t.drawImage(l,i%h*16,c,16,16,s,r,a,n)}renderQuantity(t,e,i,s){t.save(),t.fillStyle="#FFFFFF",t.strokeStyle="#000000",t.lineWidth=2,t.font="bold 12px Arial",t.textAlign="right",t.textBaseline="bottom";let r=s.toString(),a=e+this.config.slotSize-4,n=i+this.config.slotSize-4;t.strokeText(r,a,n),t.fillText(r,a,n),t.restore()}renderSlotNumber(t,e,i,s){t.save(),t.fillStyle="#CCCCCC",t.strokeStyle="#000000",t.lineWidth=1,t.font="bold 10px Arial",t.textAlign="left",t.textBaseline="top";let r=s.toString(),a=e+2,n=i+2;t.strokeText(r,a,n),t.fillText(r,a,n),t.restore()}getItemAsset(t){let e=f[t];if(e&&"number"==typeof e.index)return{index:e.index,spritePath:e.spritePath}}getSlotAt(t,e,i){let s=i-this.config.marginFromEdge-this.config.slotSize,r=this.config.marginFromTop;for(let i=0;i<this.config.slotsPerColumn;i++){let a=r+i*(this.config.slotSize+this.config.slotSpacing);if(t>=s&&t<=s+this.config.slotSize&&e>=a&&e<=a+this.config.slotSize)return i}return null}isPointInInventoryArea(t,e,i,s){let r=i-this.config.marginFromEdge-this.config.slotSize,a=this.config.marginFromTop,n=a+(this.config.slotsPerColumn-1)*(this.config.slotSize+this.config.slotSpacing)+this.config.slotSize;return t>=r&&t<=i&&e>=a&&e<=n}constructor(t){this.sprites=new Map,this.imagesLoaded=!1,this.config={slotsPerColumn:9,slotSize:48,slotSpacing:4,marginFromEdge:20,marginFromTop:20,...t},this.loadSprites()}}class b{initializeGame(t){this.player=new A({position:{x:0,y:0},health:100,attackDamage:5}),this.gameState={player:{position:{x:0,y:0},inventory:[],health:100},world:{tiles:[],npcs:[],pois:[]},timestamp:Date.now()},this.camera=new C(this.canvas),this.world=new P(new w(t)),this.movement=new x(this.world),this.animationSystem=new M,this.inventoryUI=new F,this.world.setAnimationSystem(this.animationSystem),this.movement.setDirectionChangeCallback((t,e)=>{e&&this.player.setPosition(this.gameState.player.position),this.player.setDirection(t),this.logFacingTile()}),this.gameLoop=new n(this.update.bind(this),this.render.bind(this))}start(){this.gameLoop.start()}stop(){this.gameLoop.stop()}update(t){let e=arguments.length>1&&void 0!==arguments[1]&&arguments[1];this.handlePlayerActions(),this.handleMouseInput(),this.controls.update();let i=!1;(0!==this.controls.dragDelta.x||0!==this.controls.dragDelta.y)&&(this.camera.position.x-=this.controls.dragDelta.x,this.camera.position.y-=this.controls.dragDelta.y,this.controls.dragDelta={x:0,y:0},i=!0);let s=this.gameState.player;if((s.position.x!==this.lastPlayerPos.x||s.position.y!==this.lastPlayerPos.y)&&(this.lastPlayerPos={...s.position},i=!0),this.movement.update(s,this.controls),this.camera.update(s.position),this.player.setPosition(s.position),e||i){let e=JSON.stringify(this.gameState.world.npcs);e!==this.lastNPCs&&(this.lastNPCs=e,i=!0);let r=JSON.stringify(this.gameState.world.pois);r!==this.lastPOIs&&(this.lastPOIs=r,i=!0),this.world.update(t,s.position,this.player.getInventoryItems().filter(t=>null!==t))}this.animationSystem.update(t)}render(){let t=this.canvas.getContext("2d");t&&(t.fillStyle="#000000",t.fillRect(0,0,this.canvas.width,this.canvas.height),this.world.render(t,this.camera),this.renderPlayer(t),this.animationSystem.render(t,this.camera),this.inventoryUI.render(t,this.camera,this.player.getInventoryItems(),this.player.getSelectedSlot()))}renderPlayer(t){let e=this.canvas.width/2,i=this.canvas.height/2;t.fillStyle="red",t.fillRect(e-5,i-5,10,10)}handlePlayerActions(){for(let t=1;t<=9;t++)this.controls.wasKeyJustPressed("slot".concat(t))&&this.player.selectInventorySlot(t-1);this.controls.wasKeyJustPressed("inventory")&&this.player.openInventory(),this.controls.wasKeyJustPressed("attack")&&(console.log("Attack key detected - executing attack"),this.logFacingTile(),this.handleAttack()),this.controls.wasKeyJustPressed("interact")&&(this.logFacingTile(),this.handleInteract())}handleMouseInput(){let t=this.controls.getMouseClick();if(t&&this.inventoryUI.isPointInInventoryArea(t.x,t.y,this.canvas.width,this.canvas.height)){let e=this.inventoryUI.getSlotAt(t.x,t.y,this.canvas.width);null!==e&&(this.player.selectInventorySlot(e),console.log("Mouse clicked inventory slot ".concat(e+1)))}}handleAttack(){let t=this.player.getFacingPosition(w.TILE_SIZE),e=Math.floor(t.x/w.TILE_SIZE),i=Math.floor(t.y/w.TILE_SIZE),s=this.world.getTile(e,i);if(console.log("Player attack damage: ".concat(this.player.attackDamage)),console.log("Attacking tile at (".concat(e,", ").concat(i,"): ").concat(null==s?void 0:s.value)),(null==s?void 0:s.trees)&&s.trees.length>0){let t=s.trees[0];if(t){console.log("Tree health before attack: ".concat(t.getHealth(),"/").concat(t.getMaxHealth()));let s=t.takeDamage(this.player.attackDamage);s.destroyed?(console.log("\uD83C\uDF33 Tree destroyed! Dropped ".concat(s.dropValue," ").concat(s.dropType)),this.player.addToInventory(s.dropType,s.dropValue)&&console.log("✅ Added ".concat(s.dropValue," ").concat(s.dropType," to inventory")),console.log("Tree cut down - now showing broken tree stump at (".concat(e,", ").concat(i,")"))):console.log("Tree took ".concat(this.player.attackDamage," damage. Health: ").concat(t.getHealth(),"/").concat(t.getMaxHealth()))}}else if((null==s?void 0:s.cactus)&&s.cactus.length>0){let t=s.cactus[0];if(t){console.log("Cactus health before attack: ".concat(t.getHealth(),"/").concat(t.getMaxHealth()));let r=t.takeDamage(this.player.attackDamage);if(r.destroyed){console.log("\uD83C\uDF35 Cactus destroyed! Dropped ".concat(r.dropValue," ").concat(r.dropType)),this.player.addToInventory(r.dropType,r.dropValue)&&console.log("✅ Added ".concat(r.dropValue," ").concat(r.dropType," to inventory"));let a="".concat(e,",").concat(i);this.animationSystem.removeCactus(a,t),s.cactus=s.cactus.filter(e=>e!==t),0===s.cactus.length&&(delete s.cactus,s.value="SAND",this.world.invalidateCache(),console.log("Cactus completely removed - tile converted to SAND at (".concat(e,", ").concat(i,")")))}else console.log("Cactus took ".concat(this.player.attackDamage," damage. Health: ").concat(t.getHealth(),"/").concat(t.getMaxHealth()))}}else console.log("Nothing to attack in that direction")}handleInteract(){let t=this.player.getFacingPosition(w.TILE_SIZE),e=Math.floor(t.x/w.TILE_SIZE),i=Math.floor(t.y/w.TILE_SIZE),s=this.world.getTile(e,i);console.log("Interacting with tile at (".concat(e,", ").concat(i,"):"),null==s?void 0:s.value),(null==s?void 0:s.trees)&&s.trees.length>0?console.log("Interacting with tree - could harvest fruit, check growth, etc."):(null==s?void 0:s.cactus)&&s.cactus.length>0?console.log("Interacting with cactus - could harvest water, check growth, etc."):console.log("Nothing to interact with in that direction")}logFacingTile(){let t=this.player.getFacingPosition(w.TILE_SIZE),e=Math.floor(t.x/w.TILE_SIZE),i=Math.floor(t.y/w.TILE_SIZE),s=this.world.getTile(e,i),r=(null==s?void 0:s.value)||"UNKNOWN";if((null==s?void 0:s.trees)&&s.trees.length>0){let t=s.trees[0];r+=" (Tree: ".concat(null==t?void 0:t.getHealth(),"/").concat(null==t?void 0:t.getMaxHealth()," HP)")}if((null==s?void 0:s.cactus)&&s.cactus.length>0){let t=s.cactus[0];r+=" (Cactus: ".concat(null==t?void 0:t.getHealth(),"/").concat(null==t?void 0:t.getMaxHealth()," HP)")}console.log("Facing tile: ".concat(r))}saveGame(){let t=JSON.stringify(this.gameState);localStorage.setItem("gameState",t)}loadGame(){let t=localStorage.getItem("gameState");t&&(this.gameState=JSON.parse(t))}constructor(t,e){this.lastPlayerPos={x:0,y:0},this.lastNPCs="",this.lastPOIs="",this.canvas=t,this.controls=new o(t),this.initializeGame(e)}}function D(){let t=(0,r.useRef)(null),e=(0,r.useRef)(null),i=(0,a.useSearchParams)();return(0,r.useEffect)(()=>{let s=()=>{t.current&&(t.current.width=window.innerWidth,t.current.height=window.innerHeight)};if(s(),window.addEventListener("resize",s),t.current){var r;let s=null!=(r=null==i?void 0:i.get("seed"))?r:void 0;e.current=new b(t.current,s),e.current.start()}return()=>{window.removeEventListener("resize",s),e.current&&e.current.stop()}},[i]),(0,s.jsx)("div",{className:"fixed inset-0 bg-gray-900",children:(0,s.jsx)("canvas",{ref:t,className:"w-full h-full block border-2 border-gray-700",style:{display:"block"}})})}function N(){return(0,s.jsx)(r.Suspense,{fallback:(0,s.jsx)("div",{className:"fixed inset-0 bg-gray-900 flex items-center justify-center",children:(0,s.jsx)("div",{className:"text-white text-xl",children:"Loading World Simulator..."})}),children:(0,s.jsx)(D,{})})}}},t=>{var e=e=>t(t.s=e);t.O(0,[966,309,951,358],()=>e(3779)),_N_E=t.O()}]);